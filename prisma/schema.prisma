
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  ANALYST
  HR
  MANAGER
  FINANCE
  EMPLOYEE
}

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String?   @default("No NAME")
  email         String    @unique(map: "user_email_idx")
  emailVerified DateTime? @db.Timestamp(6)
  image         String?
  password    String? //for Hash password we can use bcrypt 
  role        UserRole? @default(EMPLOYEE)
  mfaEnabled  Boolean  @default(false)
  permissions String[] @default([])

  employeeId String?   @unique @db.Uuid
  employee   Employee? @relation("UserEmployee", fields: [employeeId], references: [id], onDelete: SetNull)

  sessions Session[]
  account  Account[]

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt
}

model Account {
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])//Combine both and creates a primary key
}

model Session {
  sessionToken String   @id
  userId       String   @db.Uuid
  expires      DateTime @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model Employee {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fullName          String
  nationalId        String
  phoneNo           String
  email             String   @unique(map: "employee_email_idx")
  gender            String
  address           Json?    @db.Json
  bankAccountNumber String?
  hireDate          DateTime
  currency          String
  salary            Decimal? @db.Decimal(12, 2)
  user              User?    @relation("UserEmployee")
  // if moving to RBAC via User.role,it is posible remove this later
  accessPerssiions  String   @default("user")
  remoteWork        Boolean?

  departmentId String?     @db.Uuid
  department   Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id], onDelete: SetNull)

  //employees belongs to a branch
  branchId String? @db.Uuid
  branch   Branch? @relation("BranchEmployees", fields: [branchId], references: [id], onDelete: SetNull)

  managesBranch     Branch?     @relation("BranchManager")
  departmentManager Department? @relation("DepartmentManager")

  positionId String?   @db.Uuid
  position   Position? @relation(fields: [positionId], references: [id])

  shiftId String? @db.Uuid
  shift   Shift?  @relation(fields: [shiftId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // @@index([positionId])
  // @@index([shiftId])

  @@index([departmentId])
  @@index([branchId])
}

model Branch {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  branchName    String
  branchAddress String
  branchPhone   String
  empCount       Int

  branchEmail String

  employees Employee[] @relation("BranchEmployees") // Employees assigned to this branch

  branchManagerId String?   @unique @db.Uuid // Branch manager (picked from Employee)
  branchManager   Employee? @relation("BranchManager", fields: [branchManagerId], references: [id], onDelete: SetNull)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([branchName])
}

model Department {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  departmentName String
  empCount       Int
  depManagerId   String?   @unique @db.Uuid
  depManager     Employee? @relation("DepartmentManager", fields: [depManagerId], references: [id])

  employees Employee[] @relation("DepartmentEmployees")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([depManagerId])
}

model Position {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String  @unique
  description String?

  employees Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Shift {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String  @unique
  startTime   String
  endTime     String
  multiplier  Decimal @default(1.0) @db.Decimal(5, 2)
  description String?

  employees Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}